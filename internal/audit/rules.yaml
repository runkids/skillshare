rules:
  # ── CRITICAL: prompt injection ──
  - id: prompt-injection-0
    severity: CRITICAL
    pattern: prompt-injection
    message: "Prompt injection attempt detected"
    regex: '(?i)(ignore\s+(all\s+)?previous\s+instructions|disregard\s+(all\s+)?rules|you\s+are\s+now\b|forget\s+everything|override\s+safety)'

  - id: prompt-injection-1
    severity: CRITICAL
    pattern: prompt-injection
    message: "SYSTEM: prompt override detected"
    regex: '(?m)^SYSTEM:'

  # ── CRITICAL: data exfiltration (curl/wget + secrets) ──
  - id: data-exfiltration-0
    severity: CRITICAL
    pattern: data-exfiltration
    message: "Command may exfiltrate sensitive data"
    regex: '(?i)(curl|wget)\s+.*(\$SECRET|\$TOKEN|\$API_KEY|\$OPENAI_API_KEY|\$ANTHROPIC_API_KEY|\$AWS_SECRET)'

  - id: data-exfiltration-1
    severity: CRITICAL
    pattern: data-exfiltration
    message: "Command sends environment variables externally"
    regex: '(?i)(curl|wget)\s+.*\$\{?(HOME|USER|PATH|SSH|GPG|AWS|GITHUB_TOKEN|OPENAI|ANTHROPIC)'

  # ── CRITICAL: credential access ──
  - id: credential-access-0
    severity: CRITICAL
    pattern: credential-access
    message: "Accessing SSH private keys"
    regex: 'cat\s+~/?\.\s*ssh/(id_|known_hosts|authorized_keys|config)'

  - id: credential-access-1
    severity: CRITICAL
    pattern: credential-access
    message: "Accessing .env secrets file"
    regex: 'cat\s+\.env\b'

  - id: credential-access-2
    severity: CRITICAL
    pattern: credential-access
    message: "Accessing AWS credentials"
    regex: 'cat\s+~/?\.\s*aws/(credentials|config)'

  # ── HIGH: hidden unicode (zero-width characters) ──
  - id: hidden-unicode-0
    severity: HIGH
    pattern: hidden-unicode
    message: "Hidden zero-width Unicode characters detected"
    regex: "[\u200B\u200C\u200D\u2060\uFEFF]"

  # ── HIGH: destructive commands ──
  - id: destructive-commands-0
    severity: HIGH
    pattern: destructive-commands
    message: "Potentially destructive command"
    regex: '(?i)\brm\s+-rf\s+(/(\s|$|\*)|\*|\./)'

  - id: destructive-commands-1
    severity: HIGH
    pattern: destructive-commands
    message: "Unsafe permission change"
    regex: '(?i)\bchmod\s+777\b'

  - id: destructive-commands-2
    severity: HIGH
    pattern: destructive-commands
    message: "Sudo escalation"
    regex: '(?i)\bsudo\s+'

  - id: destructive-commands-3
    severity: HIGH
    pattern: destructive-commands
    message: "Disk overwrite command"
    regex: '(?i)\bdd\s+if='

  - id: destructive-commands-4
    severity: HIGH
    pattern: destructive-commands
    message: "Filesystem format command"
    regex: '(?i)\bmkfs\.'

  # ── HIGH: dynamic code execution (JS/Python eval/exec) ──
  - id: dynamic-code-exec-0
    severity: HIGH
    pattern: dynamic-code-exec
    message: "Dynamic code execution (eval/exec) detected"
    regex: '(?i)\b(eval|exec)\s*\('
    exclude: '(?i)\b(eval|exec)\w+\s*\('

  - id: dynamic-code-exec-1
    severity: HIGH
    pattern: dynamic-code-exec
    message: "Dynamic Function constructor detected"
    regex: '(?i)\bnew\s+Function\s*\('

  # ── HIGH: Python shell execution ──
  - id: shell-execution-0
    severity: HIGH
    pattern: shell-execution
    message: "Python shell execution detected"
    regex: '(?i)\b(os\.system|subprocess\.(run|call|Popen|check_output|check_call))\s*\('

  # ── HIGH: hidden injection in HTML comments ──
  - id: hidden-comment-injection-0
    severity: HIGH
    pattern: hidden-comment-injection
    message: "Prompt injection hidden in HTML comment"
    regex: '(?i)<!--.*?(ignore\s+(all\s+)?previous|disregard|you\s+are\s+now|forget\s+everything|override\s+safety|SYSTEM:)'

  # ── HIGH: obfuscation ──
  - id: obfuscation-0
    severity: HIGH
    pattern: obfuscation
    message: "Base64 decode pipe may hide malicious content"
    regex: '(?i)(base64\s+(-d|--decode)|\bbase64\b.*\|\s*(sh|bash|zsh|eval))'

  - id: obfuscation-1
    severity: HIGH
    pattern: obfuscation
    message: "Long base64-encoded string detected"
    regex: '[A-Za-z0-9+/]{100,}={0,2}'

  # ── MEDIUM: environment variable access (JS) ──
  - id: env-access-0
    severity: MEDIUM
    pattern: env-access
    message: "Direct environment variable access via process.env"
    regex: '\bprocess\.env\.\w+'
    exclude: '(?i)\bprocess\.env\.(NODE_ENV|npm_)'

  # ── MEDIUM: escape sequence obfuscation ──
  - id: escape-obfuscation-0
    severity: MEDIUM
    pattern: escape-obfuscation
    message: "Consecutive escape sequences may hide content"
    regex: '(\\x[0-9a-fA-F]{2}){3,}|(\\u[0-9a-fA-F]{4}){3,}'

  # ── MEDIUM: suspicious URL usage ──
  - id: suspicious-fetch-0
    severity: MEDIUM
    pattern: suspicious-fetch
    message: "URL used in command context"
    regex: '(?i)(curl|wget|invoke-webrequest|iwr)\s+[''"]?https?://'
    exclude: '(?i)https?://(localhost|127\.0\.0\.1)'

  # ── MEDIUM: system path writes ──
  - id: system-writes-0
    severity: MEDIUM
    pattern: system-writes
    message: "References to system directories"
    regex: '(?i)(write|copy|cp|mv|install)\s+.*/?(usr|etc|var|opt)/'

  # ── LOW: insecure transport hints ──
  - id: insecure-http-0
    severity: LOW
    pattern: insecure-http
    message: "Non-HTTPS URL in command context"
    regex: '(?i)(curl|wget|invoke-webrequest|iwr)\s+http://'
    exclude: '(?i)http://(localhost|127\.0\.0\.1|0\.0\.0\.0)'

  # ── HIGH: source repository link in markdown ──
  - id: source-repository-link-0
    severity: HIGH
    pattern: source-repository-link
    message: "Source repository link detected — may be used for supply-chain redirects"
    regex: '(?i)\[source\s+repo(sitory)?\]\(https?://[^)]+\)'

  # ── LOW: external links in markdown ──
  - id: external-link-0
    severity: LOW
    pattern: external-link
    message: "External URL in markdown link"
    regex: '\]\(https?://[^)]+\)'
    exclude: '(?i)(\]\(https?://(localhost|127\.0\.0\.1|0\.0\.0\.0)[:/)]|\[source\s+repo(sitory)?\]\(https?://)'

  # ── HIGH: remote code execution (pipe to interpreter) ──
  - id: fetch-with-pipe-0
    severity: HIGH
    pattern: fetch-with-pipe
    message: "Remote code execution: curl output piped to interpreter"
    regex: '(?i)\bcurl\b[^|]*\|\s*(sudo\s+)?(ba)?sh\b'

  - id: fetch-with-pipe-1
    severity: HIGH
    pattern: fetch-with-pipe
    message: "Remote code execution: wget output piped to interpreter"
    regex: '(?i)\bwget\b[^|]*\|\s*(sudo\s+)?(ba)?sh\b'

  - id: fetch-with-pipe-2
    severity: HIGH
    pattern: fetch-with-pipe
    message: "Remote code execution: fetched content piped to script interpreter"
    regex: '(?i)\b(curl|wget)\b[^|]*\|\s*(sudo\s+)?(python[23]?|node|ruby|perl|zsh|fish)\b'

  # ── MEDIUM: URL with raw IP address ──
  - id: ip-address-url-0
    severity: MEDIUM
    pattern: ip-address-url
    message: "URL with raw IP address — may bypass DNS-based security controls"
    regex: 'https?://\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}[:/\s)]'
    exclude: '(?i)https?://(127\.0\.0\.1|0\.0\.0\.0|10\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2\d|3[01])\.\d{1,3}\.\d{1,3}|192\.168\.\d{1,3}\.\d{1,3})[:/\s)]'

  # ── MEDIUM: data URI with embedded executable content ──
  - id: data-uri-0
    severity: MEDIUM
    pattern: data-uri
    message: "data: URI may embed executable or obfuscated content"
    regex: '(?i)\]\(data:[^)]+\)'

  # ── INFO: risky shell chaining patterns (advisory) ──
  - id: shell-chain-0
    severity: INFO
    pattern: shell-chain
    message: "Command chaining detected; verify intent"
    regex: '(?m)(\|\||&&|;)\s*(rm|chmod|curl|wget|bash|sh)\b'
